# Lab 03

### 编写一个基于内存的文件系统

## 系统描述

**1、文件系统基本信息**

**块大小:4K**

**大小:4GB**

**块数:1024*1024**

**2、文件到文件系统的映射**

**文件系统空间分成三部分：**

**第一部分：1个块**

**存放文件系统基本信息结构体：大小、块数、块大小、第一个文件结点指针、储存空间使用情况指针**

**第二部分：2305个块**

**存放储存空间使用情况结构体：各个块的使用情况、各个块的指针、空的块数、最大连续的空的块数、最大连续的空块中第一个块的索引**

**第三部分：剩下的块(1024*1024-2306)**

**存放文件信息结构体：其中文件元信息占用两个块，文件内容占用的块视文件大小而定。文件元信息中会有指针指向文件内容的块，其中连续的块只占用一个文件块指针，但是每个块仍然有存储空间使用情况结构体中的mempoint指针指向。**

**文件之间以链表方式联系，第一部分中的文件系统基本信息结构体中有指针指向第二部分和第三部分，故只需要查看第一个块的内容即可恢复整个文件系统的逻辑结构。**

**3、动态存储空间分配**

**算法描述：**

**当一个文件被创建时，首先分配两个块存放其元信息，两个空块是从最大连续的空块中取出两个获得的。然后根据文件内容大小分配内容块，同理，内容块尽可能的占用连续的块，当文件系统现有的最大连续的块集不满足需要的空间时，先分配这些块，再继续查找下一个最大连续的块集，以此类推。**

**算法优点：**

**简单，可以大量减少文件块指针，提高存储空间利用率(如果每一个块均有一个文件块指针或文件块索引指向的话，2000M的文件需要1M的空间来储存这些指针或索引)。**

**算法缺点：**

**可能会导致文件碎片的产生，后期效率降低。**

**算法优化：（未完成）**

**可以首先查找连续的块集中刚好满足所需大小的块集，如找不到再寻找最大的连续块集。**

**因为时间关系，这一优化暂未执行。**

**其他具体实现请参考源文件中的注释。**

## 系统测试

**1、**

```
gcc -D_FILE_OFFSET_BITS=64 -o simplefs simplefs.c -lfuse
```

**编译成功**

**2、**

```
mkdir test
./simplefs test
```

**挂载成功**

**3、**

```
cd test
ls -al
```

**输出：**

```
总用量 4
drwxr-xr-x 0 root root    0 1月   1  1970 .
drwxrwxr-x 5 py   py   4096 5月  13 10:59 ..
```

**4、**

```
echo helloworld > testfile
ls -l testfile
```

**输出：**

```
-rw-r--r-- 1 py py 11 1月  30  4449640 testfile
```

**5、**

```
cat testfile
```

**输出：**

```
helloworld
```

**6、**

```
dd if=/dev/zero of=testfile bs=1K count=200
```

**输出：**

```
记录了200+0 的读入
记录了200+0 的写出
204800 bytes (205 kB, 200 KiB) copied, 1.46895 s, 139 kB/s
```

**注意：因为文件系统读写速度较低，故大文件写入需时较长。**

**7、**

```
ls -l testfile
```

**输出：**

```
-rw-r--r-- 1 py py 204800 1月  30  4449640 testfile
```

**8、**

```
dd if=/dev/urandom of=testfile bs=1K count=2 seek=10
```

**输出：**

```
记录了2+0 的读入
记录了2+0 的写出
2048 bytes (2.0 kB, 2.0 KiB) copied, 0.0200311 s, 102 kB/s
```

**9、**

```
 ls -l testfile
```

**输出：**

```
-rw-r--r-- 1 py py 12288 1月  30  4449640 testfile
```

**10、**

````
dd if=testfile of=/dev/null
````

**输出：**

````
记录了24+0 的读入
记录了24+0 的写出
12288 bytes (12 kB, 12 KiB) copied, 0.00037644 s, 32.6 MB/s
````

**11、**

```
rm testfile
ls -al
```

**输出：**

```
总用量 4
drwxr-xr-x 0 root root    0 1月   1  1970 .
drwxrwxr-x 5 py   py   4096 5月  13 10:59 ..
```



